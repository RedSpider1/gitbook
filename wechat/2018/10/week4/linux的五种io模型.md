

I/O是通信的基础。在Java的知识体系里，I/O是非常重要的一块内容。尤其是在高并发场景下，深入理解I/O，优化I/O模型和代码十分重要。

本文将介绍linux的几种I/O模型，以及Java对I/O支持的演进介绍。

# linux网络的I/O模型简介

根据**unix网络编程**对I/O模型的分类，unix提供了五种I/O模型。分别是：

- 阻塞I/O模型
- 非阻塞I/O模型
- I/O复用模型
- 信号驱动I/O模型
- 异步I/O

作为一个Java程序员，我们或许不一定需要了解网络编程的底层细节，但应该理解I/O的基本概念，这样我们才能更好地理解Java有关I/O的类库，写出更好的代码。

网络I/O的本质是socket的读取，socket在linux系统被抽象为“流”，I/O可以理解为对这个“流”的操作。对于一次I/O访问（比如read操作），数据会先被拷贝到操作系统**内核的一个缓冲区**中，然后再从这个缓冲区拷贝到**应用程序的内存**里面。所以当一个read操作发生时，它会经历**两个阶段**：

1. 从外面复制到缓冲区，并准备数据
2. 从缓冲区复制到应用程序的内存里，并准备数据

下面分别介绍这五种linux的I/O模型。

## 1. 阻塞I/O模型

这是最常用的I/O模型。默认情况下，所有文件操作都是阻塞的。当前进程在进行I/O处理的时候，需要一直**等待**，直到两个I/O处理步骤都完成，才进行后续的操作。

因为整个进程在进行I/O操作的时候都是阻塞的，没有做其它事情，所以被称为阻塞I/O模型。

## 2. 非阻塞I/O模型

非阻塞I/O模型，当数据被复制到系统内核的缓冲区内，就立即返回。然后当前进程回去**轮询**系统内核，看它的缓冲区的数据是否准备好。直到缓冲区返回数据已经准备好的信号，再把这个数据复制到应用程序的内存中，再进行其它操作。

## 3. I/O复用模型

上述的非阻塞I/O模型有一定的弊端，那就是需要去不断轮询，这会消耗进程大量的cpu时间。那如果轮询的不是**进程的用户态**，而是别人帮忙就好了，这就是I/O多路复用模型。

linux提供了select/poll系统调用来做这个事，但select/poll有一些弊端，后来linux提供了一个改进的epoll，它们做的事情是一样的，但是epoll更高效。后续会专门介绍I/O多路复用模型。

## 4. 信号驱动I/O模型

使用信号驱动的I/O模型，当进程把数据复制到内核的缓冲区后，就不管它了，进程继续工作。当内核缓冲区的数据准备好以后，就发一个**信号**通知进程。然后进程再把这个数据复制到应用程序的内存。

## 5. 异步I/O模型

异步I/O与信号驱动I/O类似。不同的是，在信号驱动I/O模型中，是在第一个步骤完成后通知进程；而在异步I/O模型中，是在**两个步骤都完成后**再通知进程。

# I/O多路复用技术

在I/O编程中，当需要同时处理多个客户端接入请求时，可以利用多线程或者I/O多路复用技术进行处理。

I/O多路复用技术通过把多个I/O的阻塞复用到同一个select的阻塞上，从而使得系统在**单线程**的情况下可以**同时处理多个客户端请求**。

与传统的多线程和多进程模型比，I/O多路复用的最大优势是系统开销小，**系统不需要创建新的额外进程或线程**。

目前I/O多路复用的系统调用有select，pselect，poll，epoll。epoll是select/poll的替代方案。它有以下改进：

1. 支持一个进程打开的socket描述符不受限制（仅受限于操作系统的最大文件句柄数），这个值跟系统的内存关系比较大，1GB内存可以存10万个左右。
2. I/O效率不会随着socket描述符的数目的增加而线性下降。
3. 使用mmap加速内核与用户空间的消息传递。
4. epoll的api更简单。

但其实select/poll的替代方案不止epooll。比如在freeBSD下有kqueue。

# Java的I/O演进

在JDK1.4之前，基于Java的所有socket通信都采用了同步阻塞模式（BIO）。

在JDK1.4，Java新增了`Java.nio`包，以支持非阻塞I/O。主要提供了一下类和接口：

- 缓冲区ByteBuffer等
- 管道Pipe
- 用于I/O操作（阻塞和非阻塞）的channel，包括ServerSocketChannel和SocketChannel
- 多种字符集的编码能力和解码能力
- 实现非阻塞I/O操作的多路复用器selector
- 基于流行的Perl实现的正则表达式类库
- 文件通道FileChannel

在JDK1.7中，对NIO进行了进一步增强，被称为NIO2.0。主要提供了这三个方面的改进：

- 提供能够批量获取文件属性的API，并且这些API可以跨平台
- 提供AIO功能，支持基于文件的一步IO操作和针对网络套接字的异步操作
- 完成Channel通道功能，包括对配置和多播数据报的支持等
