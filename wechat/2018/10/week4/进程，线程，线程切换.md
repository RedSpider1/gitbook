本文将介绍Linux中的**进程**与**线程**的概念及他们之间的关系。然后介绍多线程的**上下文切换**，并介绍几种减少上下文切换的方式。

## 进程与线程

先来看看进程与线程的基本概念。从计算机的资源分配来讲，

- 进程是**资源分配**的基本单位；
- 线程是**CPU调度**的基本单位。

再来看看一个计算机系统的进程和线程构成。比如我们的电脑，会有许多的引用程序，比如QQ，微信，浏览器等。

一个应用程序在启动的时候，会有一个主进程。这个主进程可能会创建一些子进程。它们共同组成一个进程组。

每个进程对应一个线程组，一个线程组里面有一个主线程，也可能有其它线程。

但是主进程与子进程之间是父子关系（爸爸与儿子），而主线程与其它线程是平行关系（兄弟关系）。

## 线程切换

Linux目前模式使用NPTL线程库，采用的是一对一的线程模型。也就是一个用户态线程对应一个内核线程。内核负责每个线程的调度。

### 什么是线程切换？

线程切换就是这个线程让出CPU资源，把当前线程的上下文保存，然后换到另一个线程，加载另一个线程的上下文。就好比看书看到一般，放一个书签记下看到哪了，下次就可以继续看。

一个CPU时间片一般是几十毫秒。

### 什么时候线程会发生切换？

1. **时间片轮转**：对每一个单核CPU，同一时间只能有一个线程占用CPU资源。在多线程环境下，就需要通过时间片轮转来让每个线程都能用上CPU资源。
2. **线程阻塞**：后面的文章我们介绍线程周期的时候会介绍线程阻塞，线程阻塞一般是被动的，在抢占资源中得不到资源，被动的挂起在内存，等待某种资源或信号量（即有了资源）将他唤醒。
3. **线程主动放弃时间片**：当前线程可以主动放弃时间片（滴，好人卡！）。Java线程的yield方法就是这个功能。

## 如何减少上下文切换

减少上下文切换的方法有好几种：

- **无锁并发编程**。多线程竞争锁时，会引起上下文切换，所以多线程处理数据时，可以用一些办法来避免使用锁，如将数据的ID按照Hash算法取模分段，不同的线程处理不同段的数据。ConcurrentHashMap就是使用锁分段原理。
- **CAS算法**。Java的Atomic包使用**CAS算法**来更新数据，而不需要加锁。
- **使用最少线程**。避免创建不需要的线程，比如任务很少，但是创建了很多线程来处理，这样会造成大量线程都处于等待状态。后面我们会在介绍线程池的文章里面讨论如何传入合适的线程池参数。
- **协程**：在单线程里实现多任务的调度，并在单线程里维持多个任务间的切换。go语言支持协程，当前安卓官方语言Kotlin也支持协程。

